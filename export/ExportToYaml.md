# 1. Export your Azure Tenant Configuration to Yaml or Json

## 1.1. Benefits and Best Practices of Regularly Exporting Azure Tenant Configuration with Microsoft365DSC

Regularly exporting your Azure tenant configuration using Microsoft365DSC can be highly beneficial for several reasons:

1. Disaster Recovery: While Microsoft365DSC is not a full disaster recovery solution, having your configuration in code can significantly aid in recovering from outages or disasters. It supports your existing disaster recovery strategy by ensuring that configurations can be quickly restored1.

1. Configuration Management: Microsoft365DSC helps you manage and automate the deployment and update of Microsoft 365 settings across multiple tenants, environments, and regions. This ensures consistency and reduces the risk of configuration drift2.

1. Change Tracking: By exporting configurations regularly, you can track changes made by service administrators. This adds an approval process to deployments and helps prevent untracked changes to your Microsoft 365 tenants3.

1. Security and Compliance: Regular exports can help you maintain compliance with internal policies and external regulations. It allows you to review and audit configurations to ensure they meet security standards2.

1. Collaboration and Documentation: Exporting configurations can facilitate collaboration between different teams, such as IT, security, and compliance. It also serves as documentation for your tenant's configuration, making it easier to understand and manage2.

If doing the export on a regular basis, more tooling around the export process is required. The tooling should make the export more comfortable, customizable and be able to run within a PowerShell session as well as a build agent, for example an Azure Devops build agent.

## 1.2. The Concept

The Microsoft365DscWorkshop project on GitHub is a comprehensive initiative aimed at managing Microsoft 365 and Azure tenant configurations using Desired State Configuration (DSC). This project is designed to help organizations automate the deployment and management of Microsoft 365 services by defining configurations as code. 

The solution is designed to run on any Windows machine as well as in Azure DevOps. It uses a build agent with administrative rights to manage configurations across various workloads.

[Samper](https://github.com/gaelcolas/Sampler) uses [Invoke-Build](https://github.com/nightroman/Invoke-Build) to define tasks that can be executed locally or on any build worker in a predefined order and with dependencies. These tasks can be accessed via the project's build script. It is a similar experience to the release pipeline in common automation systems such as Azure DevOps.

This concept is used for the export to make the tasks easily accessible and run on an Azure DevOps build agent.

## 1.3. Walkthrough

The following steps guide you through the process of customizing and running the export based on the framework provided by [Sampler](https://github.com/gaelcolas/Sampler) and the [Microsoft365DscWorkshop](https://github.com/raandree/Microsoft365DscWorkshop).

> :warning: It is expected that you have created an application in the tenant you want to export. The steps to do that are described in [Export your Azure Tenant Configuration](./readme.md).

### 1.3.1. Initialize the PowerShell session by running the build script

This step sets the `PSModulePath` and imports required modules.

```powershell
.\build.ps1 -Tasks labinit
```

### 1.3.2. Configuring the configuration file

The file [Azure.yml](../source//Global//Azure.yml) stores the configuration of your Azure tenants. In this guide only one tenant will be configured and later exported.

- Please remove the `Test` and `Prod` tenant from the [Azure.yml](../source//Global//Azure.yml) file. Then put your tenant ID, tenant name and subscription ID to the remaining tenant, which should be `Dev`.

- For this use case, only the identity named `M365DscExportApplication` is of importance. Please replace the string `<AutoGeneratedLater>` for the `ApplicationID`.

    You can get the application ID via the Azure portal or by calling `Get-M365DscIdentity -Name M365DscExportApplication`. The relevant property is `AppId`.

- Next, update the certificate thumbprint for that identity by replacing the string `<AutoGeneratedLater>` with the thumbprint. The certificate should have been generated on the machine you are using right now. You can get the thumbprint via the `certlm.msc` console or by this command:

```powershell
dir Cert:\LocalMachine\My\ | Where-Object Subject -eq 'CN=M365DSC Export'
```

### Run the Export

The export is started with the command `.\build.ps1 -Tasks export`. The task `export` does these things:

- It reads the file [ExportConfiguration.yml](./ExportConfiguration.yml) to identity the DSC resources that should be part of the export.
- It exports the configuration of the Azure tenant by running the command `Export-M365DSCConfiguration`. `Export-M365DSCConfiguration` creates a PowerShell `.ps1` file containing the DSC configuration.
- The DSC configuration will be compiled into a `.mof` file, which is much easier to parse.
- Thanks to the great [Kingsland.MofParser](https://github.com/KingslandConsulting/Kingsland.MofParser), the `.mof` file can be converted into objects that can be converted into any desired data format like Json or Yaml.

### Examining the Export

After the export job is finished, you should have these files in the folder `.\output\Export`:

- The original `.ps1` output created by `Export-M365DSCConfiguration`.
- The `.mof` file which is the result of compiling the `.ps1` file.
- A Yaml file containing all the output of the DSC resources defined in the file [ExportConfiguration.yml](./ExportConfiguration.yml).

### Running the export in a Azure Pipeline

It is quite easy to run the export task in a Azure pipeline. For this, please refer to the [azure-pipelines.yml](../azure-pipelines.yml) or the pipelines in the folder [pipelines](../pipelines/).
